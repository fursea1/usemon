# Usemon Install Guide #

## Prerequisites ##
  * The collector needs a JRE version >= 5.x
  * TCP connectivity to the MySQL database on port 3306 from the machine running the collector
  * UDP Multicast connectivity from each server running the agent to the server running the collector on 224.82.199.166:16200
  * Latest version: usemon-distro-1.0-bin.tar.gz

## Files and their reason for existence ##
The 

&lt;VERSION&gt;

 part of the filename will vary depending on the version of Usemon that you are deploying.

### Static files ###
  * usemon-agent-java-

&lt;VERSION&gt;

-jar-with-dependencies.jar - The Usemon agent responsible for extracting information from the running applications
  * usemon-agent-preinstrument-java-

&lt;VERSION&gt;

-jar-with-dependencies.jar - Used to create the code needed to boostrap the agent on Java <=1.4
  * usemon-collector-java-

&lt;VERSION&gt;

-jar-with-dependencies.jar - Used to receive multicasted data from the agent and deliver them to the Usemon database

### Generated files ###
  * usemon-bootstrap.jar - Generated by the preinstrument tool for Java <=1.4 deployments

## Step by step ##

### Variables used in the guide ###
  * $JAVA5\_HOME - Java >= 5.x JRE or JDK home directory, eg. /usr/lib/jdk5/jre
  * $USEMON\_HOME - Usemon home directory (where the files were unpacked), eg. /opt/usemon
  * (Optionally) $WAS\_HOME - WebSphere home directory, eg. /opt/WebSphere/AppServer
  * (Optionally) $RESIN\_HOME - Resin home directory, eg. /opt/resin-3.1.6

### Create the database schema ###
  * There are two scripts located in usemon-collector-java-

&lt;VERSION&gt;

-jar-with-dependencies.jar, which you need to execute with your favourite mysql tool:
    1. sql/s00-create-db.sql
    1. sql/s01-create-db.sql

### Do the preinstrumentation (Only Java <=4.2) ###
  * cd $USEMON\_HOME
  * Run the usemon-agent-preinstrument-java-

&lt;VERSION&gt;

-jar-with-dependencies.jar using the app server JRE.
  * Verify that the usemon-boostrap.jar file was created and that the $USEMON\_HOME/logs directory was created

### If you are running your app server with Java security enabled ###
#### Example: Add WAS security permissions ####
Add the following in $WAS\_HOME/properties/server.policy
```
grant codeBase "file:${was.install.root}/usemon/-" {
  permission java.security.AllPermission;
};
```
The snippet assume $USEMON\_HOME to be $WAS\_HOME/usemon

### Add the agent definition to the app server java process ###
#### Example 1: WebSphere 5.1 (Java <=1.4) ####
  * In the WAS admin console to the following steps for each server to be instrumented
  * Navigate to Application Servers > SERVERNAME > Process Definition > Java Virtual Machine
  * Add system properties for the following keys (example values after the dash)
  * - usemon.system.id - eg. mySystem
  * - usemon.cluster.id - eg. myCluster
  * - usemon.server.id - eg. myServer
  * Prepend "$USEMON\_HOME/usemon-agent-java-

&lt;VERSION&gt;

-jar-with-dependencies.jar: $USEMON\_HOME/usemon-bootstrap.jar" in the Boot Classpath (or in Generic JVM arguments defined by -Xbootclasspath/p)
  * Save and sync the nodes and restart the server
  * When the server starts verify that the file usemon.log is either written to $USEMON\_HOMR/logs or $WAS\_HOME/logs

#### Example 2: Resin 3.1.6 (Java 6) ####
  * In the $RESIN\_HOME/conf/resin.conf file add
  * - "

&lt;jvm-arg&gt;

-javaagent:$USEMON\_HOME/usemon-agentjava-

&lt;VERSION&gt;

-jar-with-dependencies.jar

Unknown end tag for &lt;/jvm-arg&gt;

" to the JVM arguments section
  * - '<system-property usemon.system.id="adressa usemon.cluster.id="test"  usemon.server.id="adrtest"/>' to the System property section
  * - Verify that the usemon.log file is written to $USEMON\_HOME/logs when the server starts

### Example startup script (collector.sh) for the collector ###
```
#!/bin/sh
export JAVA_HOME=/usr/java/jdk1.5.0_11/jre

export PIDFILE=/tmp/collector.pid

EXEC_DIR=`dirname $0`

if [ -r $PIDFILE ]
then
        echo "Collector seems to be running"
        echo "Please remove $PIDFILE to force restart"
        exit 4
fi

# Saves the PID into the temporary directory
echo $$ >$PIDFILE
exec /usr/java/jdk1.5.0_11/jre/bin/java -Xmx512m -Djdbc.url=jdbc:mysql://<<<usemon.database.host>>>/usemon \
        -Dorg.usemon.logback.configfile=$USEMON_HOME/logback.xml \
        -Dusemon.cache.ehcache.configfile=classpath \
        -jar $EXEC_DIR/usemon-collector.jar
```

There is also a sample provided together with the collector. Unpack `collector.sh` and have a look.

#### Modifying the internal cache of the collector ####
Specifying -Dusemon.cache.ehcache.configfile=classpath indicates that the configuration of the internal cache should be loaded from the classpath, this is a reasonable default.

If you wish to change this, extract the file ehcache.xml from usemon-collector**.jar and modify it to your liking.**

The status of the internal cache will be reported every 5 minutes unless you specify otherwise with the property usemon.cahce.report.interval, which may be added to the command line of the collector.sh script.